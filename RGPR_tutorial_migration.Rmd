---
title: "RGPR tutorial - GPR data migration"
author: "Emanuel Huber (emanuel.huber@alumni.ethz.ch)"
date: '`r format(Sys.Date(), "%d %B %Y")`'
output: 
  pdf_document:
    toc: yes
    number_sections: true
    highlight: tango
  html_document: 
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    self_contained: no
    theme: default
    toc: yes
    includes:
      in_header: header.html
linkcolor: red
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/media/huber/Elements/UNIBAS/software/codeR/package_RGPR/RGPR-gh-pages/2014_04_25_frenke") 
```

***

`RGPR` is a package for [R](https://cran.r-project.org/) to read, write, analyse and visualise ground-penetrating radar (GPR) data.
  

**Note**: 

* This R-package is still in development, and therefore some of the functions may change in a near future. 
* The R-package `RGPR` is hosted on [GitHub](https://github.com/) at [https://github.com/emanuelhuber/RGPR](https://github.com/emanuelhuber/RGPR). 
* You can contribute to the development of `RGPR`: 
    1. create an account on [GitHub](https://github.com/),
    2. [fork](https://guides.github.com/activities/forking/) `RGPR`, 
    3. change the code
    4. make a [pull request](https://guides.github.com/activities/forking/#making-a-pull-request) (sumbmit your modifications).

If you have any questions, comments or wishes, etc. feel free to contact me (in english, french or german): <emanuel.huber@alumni.ethz.ch>.

# Objectives of this tutorial
**Learn how to migrate GPR data.**

Note that his tutorial will not explain you the math/algorithms behind the different processing methods.

<!--
In this tutorial the code snippets are in monospaced typewriter font like in the following example:
```{r, eval=FALSE, echo=TRUE}
1 + exp(1:10)
```

The R output are preceded by a double hash (`##`). The following R output is from the code snippet above.
```{r, eval=TRUE,echo=FALSE}
1 + exp(1:10)
```

Create a text file and save it with the `.R` extension (the extension for the R-script files). Then copy the code snippets into your R-script file and adapt them to your needs. To run the code in R, copy the code and paste it into the R console. You can also manually enter the code.

Don't hesitate to consult the help files and to search for help on the internet. For example, to see the help for the function `mean()`, enter:

```{r,eval=FALSE}
?mean    # open the help file related to the function mean()
```
-->

# Preliminary

* Read the tutorial [RGPR - Getting started (tutorial 1)](http://emanuelhuber.github.io/RGPR/RGPR_tutorial_installation-load.html)
* Read the tutorial [Basic GPR data processing (tutorial 2)](http://emanuelhuber.github.io/RGPR/RGPR_tutorial_basic-processing.html)
* Read the tutorial [Add coordinates to the GPR data (tutorial 3)](http://emanuelhuber.github.io/RGPR/RGPR_tutorial_RGPR-survey.html)
* Download the data [2014_04_25_frenke.zip](http://emanuelhuber.github.io/RGPR/2014_04_25_frenke.zip)

## File organisation
I recommand you to first think about the organisation of your files and directories. I suggest to organise them as follows:
```
/2014_04_25_frenke   (project directory with date and location)
    /processing      (here you will save the processed GPR files)
    /rawGPR          (the raw GPR data, never modify them!)
    RGPR_tutorial.R  (this is you R script for this tutorial)
```


## Install/load the necessary packages and et the working directory
Load the packages `RGPR` and `rChoiceDialogs` (`rChoiceDialogs` provides a collection of portable choice dialog widgets):
```{r, warning=FALSE, message=FALSE}
library(devtools)
devtools::install_github("emanuelhuber/RGPR")
library(RGPR)   # load RGPR in the current R session
library(rChoiceDialogs)
myDir <- "/media/huber/Elements/UNIBAS/software/codeR/package_RGPR/RGPR-gh-pages/2014_04_25_frenke"
setwd(myDir)    # set the working directory
getwd()         # Return the current working directory (just to check)
```


# Read GPR data

```{r, echo=TRUE}
A <- readGPR(fPath = "rawGPR/LINE00.DT1")   # the filepath is case sensitive!
```


# Pre-processing

## Add topographic data (coordinates)
We assume that for each GPR record there is a file containing the (x, y, z) 
coordinates of every traces. The header of these files is "E", "N", "Z" 
instead of "x", "y", "z" because in topography "x" sometimes designates the 
North ("N") and not the East ("E") as we would expect. The designation
"E", "N", "Z" is less prone to confusion and therefore we chose it!

1. Define the filepaths to the topo files:
```{r, echo=TRUE}
TOPO <- file.path(getwd(), "coord/topo/LINE00.txt")
```

2. Read all the files with the funciton `readTopo()` that creates a list whose 
elements correspond to the GPR record and contain all the trace coordinates:
```{r, echo=TRUE}
TOPOList <- readTopo(TOPO, sep = "\t")
```

3. Set the list of coordinates as the new coordinates to the GPRsurvey object:
```{r, echo=TRUE}
coord(A) <- TOPOList[[1]]
```


## DC shift removal
Remove the DC-offset estimated on the first n samples usind the function 
`dcshift()`. This function takes as argument the `GPR` object and the sample 
index used to estimate the DC shift (in this case, the first \(110\) samples):
```{r, echo=TRUE}
A1 <- dcshift(A, 1:110)   # new object A1 
```



## First wave break estimation and set time-zero

The first wave break is estimated for each traces
```{r, eval=TRUE}
tfb <- firstBreak(A1)   # take some time
```

Convert the first wave break time into time-zero with `firstBreakToTime0()`. Here we define [time-zero] = [first wave break] - [air wave travel time between 
transmitter and receiver]. 
```{r, echo=TRUE}
t0 <- firstBreakToTime0(tfb, A1)
time0(A1) <- t0     # set time0 to A1
```

To shift the traces to time-zero, use the function `time0Cor`.

```{r, eval=TRUE}
A2 <- time0Cor(A1, method = "spline")
```


## Dewow
Remove the low-frequency components (the so-called "wow") of the GPR record 
with:

```{r, echo=TRUE,message=FALSE}
A3 <- dewow(A2, type = "MAD", w = 50)     # dewowing: take some time
```

## Frequency filter

Eliminate the high-frequency (noise) component of 
the GPR record with a bandpass filter. We define as corner frequencies 
at \(150\,MHz\) and \(260\,MHz\), and set 
`plotSpec = TRUE` to plot the spectrum with the signal, the filtered signal and 
the filter.

```{r, echo=TRUE}
A4 <- fFilter(A3, f = c(150, 260), type = "low", plotSpec = TRUE)
```



## Time gain
Apply a power gain and a spherical gain to compensate for geometric wave 
spreading and attenuation (Kruse and Jol, 2003; Grimm et al., 2006).

```{r, echo=TRUE}
A5 <- gain(A4, type = "power", alpha = 1, te = 150, tcst = 20)
A6 <- gain(A5, type = "exp", alpha = 0.11, t0 = 0, te = 125)
```



# Topographic Kirchhoff migration
See *Dujardin & Bano (2013, Topographic migration of GPR data: 
Examples from Chad and Mongolia, Comptes Rendus GÃ©oscience, 345(2):73-80.
Doi : 10.1016/j.crte.2013.01.003)*

## Pre-processing

### Constant offset correction
Time correction for each trace to compensate the offset between transmitter 
and receiver antennae (it converts the trace time of the data acquired with
a bistatic antenna system into trace time data virtually acquiered with 
a monostatic system)


```{r, eval=TRUE}
A7 <- timeCorOffset(A6)
plot(A7)
```

### Time upsampling (sinc-interpolation) of the GPR data to reduce the aliasing risk.
```{r, eval=TRUE, message=FALSE,warning=FALSE}
A8 <- upsample(A7, n = c(3,1))
```


## Topographic Kirchhoff migration.

Vertical resolution of the migrated data: `dz = 0.01`m.

Dominant frequency from `spec(A9)`: `fdo = 80` MHz (used to estimate the Fresnel zone).

For the moment the algorithm works **only with a constant radar wave velocity**. In this example the velocity is:
```{r, eval=TRUE, message=FALSE,warning=FALSE}
vel(A8)         # velocity
depthunit(A8)   # units: nano-second (ns)
```

To change the velocity, simply do:
```{r, eval=FALSE, message=FALSE,warning=FALSE}
vel(A8)  <- 0.09        # velocity in ns
```



```{r, eval=TRUE, message=FALSE,warning=FALSE}
A9 <- migration(A8, type="kirchhoff", max_depth = 10, 
                 dz = 0.01, fdo = 80)
plot(A9)
```

You don't see so much: we need some post-processing!

## Post-processing

Trace smoothing with a Gaussian filter
```{r, eval=TRUE, message=FALSE,warning=FALSE}
A10 <- filter1D(A9, type="Gaussian", sigma=2.5) 
```

Automatic gain control
```{r, eval=TRUE, message=FALSE,warning=FALSE}
A11 <- gain(A10, type="agc", w=0.55) 
```

inverse normal transformations
```{r, echo=TRUE}
A12 <- traceScaling(A11, type = "invNormal")
```


## Comparison before/after migration

Before migration
```{r, echo=TRUE}
plot(traceScaling(A8, type = "invNormal"))
```

After migration

```{r, echo=TRUE}
plot(A12)
```


